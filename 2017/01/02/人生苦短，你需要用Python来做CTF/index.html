<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="robots" content="index,follow"><meta name="description" content="#0X00-前言0X00 前言 前一阵子，为了活跃一下群里的气氛，出了一道小题涉及到一些编码，反编译，解密的知识的题目让大家玩，如果你比较感兴趣的话也可以先试着做一做。  #0X01-获取KEY0X01 获取KEY"><meta name="keywords" content="ctf,python,pycodeobject,utf9,uncompyle2,marshal,解密"><meta property="og:type" content="article"><meta property="og:title" content="人生苦短，你需要用Python来做CTF"><meta property="og:url" content="https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/index.html"><meta property="og:site_name" content="Hackfun"><meta property="og:description" content="#0X00-前言0X00 前言 前一阵子，为了活跃一下群里的气氛，出了一道小题涉及到一些编码，反编译，解密的知识的题目让大家玩，如果你比较感兴趣的话也可以先试着做一做。  #0X01-获取KEY0X01 获取KEY"><meta property="og:image" content="https://www.hackfun.org/usr/uploads/2017/03/1789796538.png"><meta property="og:image" content="https://www.hackfun.org/usr/uploads/2017/03/2422032094.png"><meta property="og:image" content="https://www.hackfun.org/usr/uploads/2017/03/3384744252.png"><meta property="og:image" content="https://www.hackfun.org/usr/uploads/2017/03/2696293271.png"><meta property="og:image" content="https://www.hackfun.org/usr/uploads/2017/03/918721047.png"><meta property="og:updated_time" content="2017-10-02T19:22:31.849Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="人生苦短，你需要用Python来做CTF"><meta name="twitter:description" content="#0X00-前言0X00 前言 前一阵子，为了活跃一下群里的气氛，出了一道小题涉及到一些编码，反编译，解密的知识的题目让大家玩，如果你比较感兴趣的话也可以先试着做一做。  #0X01-获取KEY0X01 获取KEY"><meta name="twitter:image" content="https://www.hackfun.org/usr/uploads/2017/03/1789796538.png"><meta name="twitter:creator" content="@jinglingbiaodi"><link rel="publisher" href="https://plus.google.com/117450799036676139034"><meta property="fb:admins" content="jinglingbiaodi"><meta property="fb:app_id" content="jinglingbiaodi"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>人生苦短，你需要用Python来做CTF</title><link rel="stylesheet" href="/css/style.css"><link rel="alternate" href="/atom.xml" title="Hackfun - | Secblog | Pentest | Auditing | Sectool | CTF Write-up" type="application/atom+xml"></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Link</a></li><li><a href="/archives/">Archives</a></li><li><a href="http://github.com/sunnyelf">Projects</a></li><li><a href="/search/">Search</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="/2017/01/04/一道可以学到密码知识的CTF密码学题目/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/2016/11/25/Linux平台C语言Socket编程练习之线程专用数据TSD实现/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&text=人生苦短，你需要用Python来做CTF"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&is_video=false&description=人生苦短，你需要用Python来做CTF"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=人生苦短，你需要用Python来做CTF&body=Check out this article: https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-digg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.tumblr.com/share/link?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&name=人生苦短，你需要用Python来做CTF&description=&lt;h2 id=&#34;0x00-前言&#34;&gt;&lt;a href=&#34;#0x00-前言&#34; class=&#34;headerlink&#34; title=&#34;0x00 前言&#34;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;前一阵子，为了活跃一下群里的气氛，出了一道小题涉及到一些编码，反编译，解密的知识的题目让大家玩，如果你比较感兴趣的话也可以先试着做一做。&lt;/p&gt;&lt;h2 id=&#34;0x01-获取key&#34;&gt;&lt;a href=&#34;#0x01-获取key&#34; class=&#34;headerlink&#34; title=&#34;0x01 获取key&#34;&gt;&lt;/a&gt;0x01 获取key&lt;/h2&gt;"><i class="fa fa-tumblr" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-获取key"><span class="toc-number">2.</span> <span class="toc-text">0x01 获取key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-分析flag-py"><span class="toc-number">3.</span> <span class="toc-text">0x02 分析flag.py</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-提取得到pyc文件"><span class="toc-number">4.</span> <span class="toc-text">0x03 提取得到pyc文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-反编译pyc文件得到py源文件"><span class="toc-number">5.</span> <span class="toc-text">0x04 反编译pyc文件得到py源文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-分析py源文件中加密算法"><span class="toc-number">6.</span> <span class="toc-text">0x05 分析py源文件中加密算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-编写解密代码"><span class="toc-number">7.</span> <span class="toc-text">0x06 编写解密代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-后话"><span class="toc-number">8.</span> <span class="toc-text">0x07 后话</span></a></li></ol></div></span></div><div class="content index width mx-auto px2 my4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">人生苦短，你需要用Python来做CTF</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><i class="fa fa-user-secret"></i><span itemprop="name">Jing Ling</span> </span><i class="fa fa-calendar"></i><div class="postdate"><time datetime="2017-01-01T23:45:00.000Z" itemprop="datePublished">2017-01-02</time></div><i class="fa fa-eye"></i><span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span></span><div class="article-tag"><i class="fa fa-tags"></i> <a class="tag-link" href="/tags/ctf/">ctf</a>, <a class="tag-link" href="/tags/marshal/">marshal</a>, <a class="tag-link" href="/tags/pycodeobject/">pycodeobject</a>, <a class="tag-link" href="/tags/python/">python</a>, <a class="tag-link" href="/tags/uncompyle2/">uncompyle2</a>, <a class="tag-link" href="/tags/utf9/">utf9</a>, <a class="tag-link" href="/tags/解密/">解密</a></div></div></header><div class="content" itemprop="articleBody"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>前一阵子，为了活跃一下群里的气氛，出了一道小题涉及到一些编码，反编译，解密的知识的题目让大家玩，如果你比较感兴趣的话也可以先试着做一做。</p><h2 id="0x01-获取key"><a href="#0x01-获取key" class="headerlink" title="0x01 获取key"></a>0x01 获取key</h2><a id="more"></a><p>下载得到题目包<a href="https://github.com/sunnyelf/you_need_python_write_up/" target="_blank" rel="external">you_need_python.zip</a>，解压得到flag.py和key_is_here_but_do_you_know_rfc4042和两个文件，尝试运行flag.py：</p><p><img src="https://www.hackfun.org/usr/uploads/2017/03/1789796538.png" alt="1.png"></p><p>要求输入key，由另一个文件名key_is_here_but_do_you_know_rfc4042，可知key需要从key_is_here_but_do_you_know_rfc4042中获得，查看key_is_here_but_do_you_know_rfc4042文件的内容：</p><p><img src="https://www.hackfun.org/usr/uploads/2017/03/2422032094.png" alt="2.png"></p><p>文件内容是一些乱码，但是文件名提示了rfc4042，于是网上查询相关资料，知道rfc4042中定义了utf9和utf18两种Unicode转换编码格式，在了解转换原理之后，根据题意推测是将uft9编码转化了utf8编码，通过资料查询得知python已有utf9模块（如果没有查询到也可以自己动手编写转换代码），使用pip安装utf9模块：<br></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pip search utf9  </div><div class="line">pip install utf9</div></pre></td></tr></table></figure><p></p><p>编写代码将文件内容的uft9编码转化utf8编码：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding utf-8</span></div><div class="line"><span class="comment">#utf9_to_utf8.py</span></div><div class="line"><span class="keyword">import</span> utf9</div><div class="line"></div><div class="line">utf9_file = open(<span class="string">'key_is_here_but_do_you_know_rfc4042'</span>,<span class="string">'rb'</span>)</div><div class="line">utf9_data = utf9_file.read()</div><div class="line">decoded_data = utf9.utf9decode(utf9_data)</div><div class="line"><span class="keyword">print</span> decoded_data</div><div class="line">decoded_file = open(<span class="string">'decoded'</span>,<span class="string">'w'</span>)</div><div class="line">decoded_file.write(decoded_data)</div><div class="line">decoded_file.close()</div></pre></td></tr></table></figure><p></p><p><img src="https://www.hackfun.org/usr/uploads/2017/03/3384744252.png" alt="3.png"></p><p>得到一堆符号串，但是经常仔细观察，除了“<em>”符号外，其他符号都是Python中的算数运算符，“(”，“)”括号表示优先级，然后开脑洞“</em>”为数字“1”，“<strong>”为数字“2”，依次类推“<strong>___</strong></strong>”为数字“9”，在熟悉了utf9模块的使用后尝试编写转换代码，代码执行后得到数字：5287002131074331513，尝试转换为16进制然后转换为ASCII字符：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding=utf-8</span></div><div class="line"><span class="comment">#key_show.py</span></div><div class="line"><span class="keyword">import</span> binascii</div><div class="line"></div><div class="line">_ = <span class="number">1</span></div><div class="line">__ = <span class="number">2</span></div><div class="line">___ = <span class="number">3</span></div><div class="line">____ = <span class="number">4</span></div><div class="line">_____ = <span class="number">5</span></div><div class="line">______ = <span class="number">6</span></div><div class="line">_______ = <span class="number">7</span></div><div class="line">________ = <span class="number">8</span></div><div class="line">_________ = <span class="number">9</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> binascii.a2b_hex(hex(eval(<span class="string">"_____*((__//__+___+______-____%____)**((___%(___-_))+________+(___%___+_____+_______%__+______-(______//(_____%___)))))+__*(((________/__)+___%__+_______-(________//____))**(_*(_____+_____)+_______+_________%___))+________*(((_________//__+________%__)+(_______-_))**((___+_______)+_________-(______//__)))+_______*((___+_________-(______//___-_______%__%_))**(_____+_____+_____))+__*(__+_________-(___//___-_________%_____%__))**(_________-____+_______)+(___+_______)**(________%___%__+_____+______)+(_____-__)*((____//____-_____%____%_)+_________)**(_____-(_______//_______+_________%___)+______)+(_____+(_________%_______)*__+_)**_________+_______*(((_________%_______)*__+_______-(________//________))**_______)+(________/__)*(((____-_+_______)*(______+____))**___)+___*((__+_________-_)**_____)+___*(((___+_______-______/___+__-_________%_____%__)*(___-_+________/__+_________%_____))**__)+(_//_)*(((________%___%__+_____+_____)%______)+_______-_)**___+_____*((______/(_____%___))+_______)*((_________%_______)*__+_____+_)+___//___+_________+_________/___"</span>))[<span class="number">2</span>:][:<span class="number">-1</span>])</div></pre></td></tr></table></figure><p></p><p>运行得到key。</p><h2 id="0x02-分析flag-py"><a href="#0x02-分析flag-py" class="headerlink" title="0x02 分析flag.py"></a>0x02 分析flag.py</h2><p><img src="https://www.hackfun.org/usr/uploads/2017/03/2696293271.png" alt="4.png"></p><p>查询有关marshal, zlib, base64模块和exec函数的资料，反向推测源代码或字节码先是使用marshal模块序列化，之后使用zlib压缩，最后使用base64编码，而exec语句可以用来执行储存在字符串或者文件中的python语句或python字节码。所以尝试提取exec语句执行的内容：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> marshal, zlib, base64</div><div class="line">code = marshal.loads(zlib.decompress(base64.b64decode(<span class="string">'eJxtVP9r21YQvyd/ieWm66Cd03QM1B8C3pggUuzYCSWstHSFQijyoJBhhGq9OXJl2ZFeqAMOK6Q/94f9Ofvn1s+d7Lgtk/3O997du/vc584a0eqpYP2GVfwDEeOrKCU6g2LRRyiK4oooFsVVUSqkqxTX6J1F+SfSNYrrdKPorC76luhbpOEGCZNFZw2KG3Rmk26QtuXi3xTb7ND6/aVu0g2RuvhEcZNut5lAGbTvAFbyH57TkYLKy8J6xpDvQxiiiaIlcdqJxVcHbXY6bXNlZgviPCrO0+StqfKd88gzNh/qRZyMdWHE29TZZvIkG7eZFRGGRcBmsXJaUoKCQ9fWKHwSqNeKFnsM5PnwJ7q2aKk4AFhcWtQCh+ChB5+Lu/RmyYUxmtOEYxas7i/2iuR7Ti14OEOSmU0RADd4+dQzbM1FJhukAUeQ+kZROuLyioagrau76kc1slY1NNaY/y3LAxDQBrAICJisV2hMdF2lxQcyFuMoqcX3+TCl6xotqzSpkqmxYVmjXVjAXiwBsEfBrd1VvTvLCj2EXRnhoryAKdpxcIgJcowUB68yAx/tlCAuPHqDuZo0CN3CUGHwkPhGMA7aXMfphjbmQLhLhJcHa0a+mpgB191c1U1lnHJQbgkHx+WGxeJbejnpkzSavo2jkxZ7i725npGAaTc8FXmUjbUETHUmkxXN5zqL5WiWxwE7Bc11yyYzNJpN02jerq+DzNNodfxOX8kE4FcmYKscDdYD1oPGGucXYNmgs1F+NTf3GOt3Mg7b+NTVruqoQyX1hOEUacKw+AGbP38ZOq9THRXaSbL5pXGQ8bho/Z/lrzQaHxdoCrlev+t6nZ7re57r+57rHXag93Deh37k+vuw9zorO/Qj/B50cAf2oyOsvut3D+ADWxdxfN/1Drqu39mHzvcRswv/Hvz7sHeg9w8Qzy99DzuFwxhPhs6zWTbOI3OZRiaZZcVj5wVwOklx7OwVxR47PR46r/SVM8ulBJic9zku/eqY/MqJxiDj+Gd55wS3f35pbLCzHoEwzKKpDkN5i+TR+1AYCWTo5IV0Z0P9H3phDDd6lMzPdS5bbo9eJGbTsW9nbDqLL1N9Iq+rRxDbll2x67a9Lf27hw5uK1s1rZr6DOPF+FI='</span>)))  </div><div class="line"><span class="keyword">print</span> <span class="string">"type of code:%s"</span> %type(code)</div></pre></td></tr></table></figure><p></p><p><img src="https://www.hackfun.org/usr/uploads/2017/03/918721047.png" alt="5.png"></p><p>得知code类型为Python代码对象（PyCodeObject），为了便于题目讲解，以下简单阐述个人对Python解释器运行原理，pyc文件格式以及Python代码对象的理解。</p><p>当你使用命令python demo.py（这里的python其实是python解释器中的CPython）时 ，会启动 Python解释器，Python解释器首先会检查当前目录是否存在相应的demo.pyc或demo.pyo文件（pyo文件是经过Python解释器编译优化，然后将内存中的字节码对象序列化并加上pyo文件头信息的可储存的二进制文件），如果都存在优先检查运行demo.pyo，如果不存在相应的demo.pyc或demo.pyo那么Python解释器就会编译demo.py，因为Python解释器检查运行pyc文件和pyo文件两者过程类似，下面以pyc文件为例，如果存在相应的pyc文件Python解释器则验证demo.pyc文件头的前四个字节幻数（magic number）的值，以确保当前文件是pyc文件格式且当前Python解释器版本能支持，如果验证不通过则给出提示退出，如果验证通过继续检查demo.pyc文件头的后四个字节py源文件修改时间（mtime，modify time），如果demo.pyc文件头的mtime和现在demo.py源文件的修改时间一样，那么Python解释器就会把demo.pyc（不包括文件头的8个字节）加载到内存并将demo.pyc文件反序列化为代码对象交给Python虚拟机（Python虚拟机只是Python解释器中实现的一部分，为了便于理解人们把这部分抽象命名为Python虚拟机）处理执行，运行完毕Python解释器退出。如果demo.pyc文件头的mtime早于现在py源文件的修改时间，说明之前的demo.py源文件经过了修改需要重新编译。</p><p>Python解释器所做的工作就不深入了，可以简单理解为Python解释器将demo.py加载到内存编译一个对应的字节码对象，然后交由Python虚拟机程序处理执行，Python 虚拟机会从编译得到的代码对象中依次读入每一条字节码指令，并在当前的上下文环境中执行这条字节码指令。而执行完毕之后Python编译器会根据情况生成相应的pyc文件，生成过程为Python解释器将内存的Python代码对象反序列化并加上相应的py文件头信息一起写入到硬盘，所以pyc文件只是Python代码对象在硬盘上的表现形式，生成pyo文件过程也类似，只是多了Python解释器优化的过程。</p><h2 id="0x03-提取得到pyc文件"><a href="#0x03-提取得到pyc文件" class="headerlink" title="0x03 提取得到pyc文件"></a>0x03 提取得到pyc文件</h2><p>所以我们要做的便是编写代码将code这个Python代码对象加上相应pyc文件头信息提取出来写入磁盘生成pyc文件，生成pyc文件目的是便于我们反编译pyc文件得到相应的py源码。当然你也可以通过Python自带的dis模块慢慢分析pyc文件中的字节码指令。<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment">#coding = utf-8</span></div><div class="line"><span class="comment">#PyCodeObject_to_pyc.py</span></div><div class="line"><span class="keyword">import</span> py_compile, imp, os, marshal, zlib, base64</div><div class="line"></div><div class="line">code = marshal.loads(zlib.decompress(base64.b64decode(<span class="string">'eJxtVP9r21YQvyd/ieWm66Cd03QM1B8C3pggUuzYCSWstHSFQijyoJBhhGq9OXJl2ZFeqAMOK6Q/94f9Ofvn1s+d7Lgtk/3O997du/vc584a0eqpYP2GVfwDEeOrKCU6g2LRRyiK4oooFsVVUSqkqxTX6J1F+SfSNYrrdKPorC76luhbpOEGCZNFZw2KG3Rmk26QtuXi3xTb7ND6/aVu0g2RuvhEcZNut5lAGbTvAFbyH57TkYLKy8J6xpDvQxiiiaIlcdqJxVcHbXY6bXNlZgviPCrO0+StqfKd88gzNh/qRZyMdWHE29TZZvIkG7eZFRGGRcBmsXJaUoKCQ9fWKHwSqNeKFnsM5PnwJ7q2aKk4AFhcWtQCh+ChB5+Lu/RmyYUxmtOEYxas7i/2iuR7Ti14OEOSmU0RADd4+dQzbM1FJhukAUeQ+kZROuLyioagrau76kc1slY1NNaY/y3LAxDQBrAICJisV2hMdF2lxQcyFuMoqcX3+TCl6xotqzSpkqmxYVmjXVjAXiwBsEfBrd1VvTvLCj2EXRnhoryAKdpxcIgJcowUB68yAx/tlCAuPHqDuZo0CN3CUGHwkPhGMA7aXMfphjbmQLhLhJcHa0a+mpgB191c1U1lnHJQbgkHx+WGxeJbejnpkzSavo2jkxZ7i725npGAaTc8FXmUjbUETHUmkxXN5zqL5WiWxwE7Bc11yyYzNJpN02jerq+DzNNodfxOX8kE4FcmYKscDdYD1oPGGucXYNmgs1F+NTf3GOt3Mg7b+NTVruqoQyX1hOEUacKw+AGbP38ZOq9THRXaSbL5pXGQ8bho/Z/lrzQaHxdoCrlev+t6nZ7re57r+57rHXag93Deh37k+vuw9zorO/Qj/B50cAf2oyOsvut3D+ADWxdxfN/1Drqu39mHzvcRswv/Hvz7sHeg9w8Qzy99DzuFwxhPhs6zWTbOI3OZRiaZZcVj5wVwOklx7OwVxR47PR46r/SVM8ulBJic9zku/eqY/MqJxiDj+Gd55wS3f35pbLCzHoEwzKKpDkN5i+TR+1AYCWTo5IV0Z0P9H3phDDd6lMzPdS5bbo9eJGbTsW9nbDqLL1N9Iq+rRxDbll2x67a9Lf27hw5uK1s1rZr6DOPF+FI='</span>)))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">PyCodeObject_to_pyc</span><span class="params">(py_code_obj, pyc_file)</span>:</span></div><div class="line">    <span class="keyword">with</span> open(pyc_file, <span class="string">'wb'</span>) <span class="keyword">as</span> pyc:</div><div class="line">        pyc_magic = imp.get_magic()</div><div class="line">        pyc.write(pyc_magic)</div><div class="line">        mtime = long(os.fstat(pyc.fileno()).st_mtime)</div><div class="line">        py_compile.wr_long(pyc, mtime)</div><div class="line">        marshal.dump(py_code_obj, pyc)</div><div class="line">        pyc.flush()</div><div class="line">        pyc.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    PyCodeObject_to_pyc(code, <span class="string">'extract.pyc'</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure><p></p><h2 id="0x04-反编译pyc文件得到py源文件"><a href="#0x04-反编译pyc文件得到py源文件" class="headerlink" title="0x04 反编译pyc文件得到py源文件"></a>0x04 反编译pyc文件得到py源文件</h2><p>将生成的pyc通过Python工具如uncompyle2等反编译得到py源码，这里直接通过在线的pyc反编译网站得到py源码：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># encoding: utf-8</span></div><div class="line"><span class="comment">#source.py</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> hashlib</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sha1</span><span class="params">(string)</span>:</span></div><div class="line">    <span class="keyword">return</span> hashlib.sha1(string).hexdigest()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span><span class="params">(strSHA1)</span>:</span></div><div class="line">    r = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> strSHA1:</div><div class="line">        r += int(<span class="string">'0x%s'</span> % i, <span class="number">16</span>)</div><div class="line">    <span class="keyword">return</span> r</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(plain, key)</span>:</span></div><div class="line">    keySHA1 = sha1(key)</div><div class="line">    intSHA1 = calc(keySHA1)</div><div class="line">    r = []</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(plain)):</div><div class="line">        r.append(ord(plain[i]) + int(<span class="string">'0x%s'</span> % keySHA1[i % <span class="number">40</span>], <span class="number">16</span>) - intSHA1)</div><div class="line">        intSHA1 = calc(sha1(plain[:i + <span class="number">1</span>])[:<span class="number">20</span>] + sha1(str(intSHA1))[:<span class="number">20</span>])</div><div class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(map((<span class="keyword">lambda</span> x: str(x)), r))</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    key = raw_input(<span class="string">'[*] Please input key:'</span>)</div><div class="line">    plain = raw_input(<span class="string">'[*] Please input flag:'</span>)</div><div class="line">    encryptText = encrypt(plain, key)</div><div class="line">    cipherText = <span class="string">'-185-147-211-221-164-217-188-169-205-174-211-225-191-234-148-199-198-253-175-157-222-135-240-229-201-154-178-187-244-183-212-222-164'</span></div><div class="line">    <span class="keyword">if</span> encryptText == cipherText:</div><div class="line">        <span class="keyword">print</span> <span class="string">'[&gt;] Congratulations! Flag is: %s'</span> % plain</div><div class="line">        exit()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'[!] Key or flag is wrong, try again:)'</span></div><div class="line">        exit()</div></pre></td></tr></table></figure><p></p><h2 id="0x05-分析py源文件中加密算法"><a href="#0x05-分析py源文件中加密算法" class="headerlink" title="0x05 分析py源文件中加密算法"></a>0x05 分析py源文件中加密算法</h2><p>sha1函数使用sha1算法计算返回40位16进制散列值，calc函数计算40位16进制散列值中每位的整型值并相加，最后返回整型的总和值。<br>encrypt函数为核心加密算法函数：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(plain, key)</span>:</span></div><div class="line">    keySHA1 = sha1(key)</div><div class="line">    intSHA1 = calc(keySHA1)</div><div class="line">    r = []</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(plain)):</div><div class="line">        r.append(ord(plain[i]) + int(<span class="string">'0x%s'</span> % keySHA1[i % <span class="number">40</span>], <span class="number">16</span>) - intSHA1)</div><div class="line">        intSHA1 = calc(sha1(plain[:i + <span class="number">1</span>])[:<span class="number">20</span>] + sha1(str(intSHA1))[:<span class="number">20</span>])</div><div class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(map((<span class="keyword">lambda</span> x: str(x)), r))</div></pre></td></tr></table></figure><p></p><p>由第4行的for可以知道到明文长度和密文长度相同，核心加密语句为第6，7行，算法使用ord函数取得明文每个字符的ASCII整型值，int函数内容为明文每个字符位置模40访问由调用sha1函数返回的40位16进制keySHA1字符串中的16进制数并转化为10进制数与由调用calc函数返回的整型值相减，然后将ord函数和int计算所得值作为密文添加到r列表，第7行更新intSHA1值，第9行转换为“-185-147-211…”格式并返回。<br>这里我们知道了密文cipherText，密钥key，加密算法encrypt，从而能逆推出解密算法，只要把密文值减去int函数中的值并对结果使用chr函数取得明文plain。</p><h2 id="0x06-编写解密代码"><a href="#0x06-编写解密代码" class="headerlink" title="0x06 编写解密代码"></a>0x06 编写解密代码</h2><pre><code class="py"><span class="comment">#coding:utf-8</span>
<span class="comment">#decrypt.py</span>

<span class="keyword">import</span> hashlib

<span class="function"><span class="keyword">def</span> <span class="title">sha1</span><span class="params">(string)</span>:</span>
    <span class="keyword">return</span> hashlib.sha1(string).hexdigest()

<span class="function"><span class="keyword">def</span> <span class="title">calc</span><span class="params">(strSHA1)</span>:</span>
    r = <span class="number">0</span>
    <span class="keyword">for</span> i <span class="keyword">in</span> strSHA1:
        r += int(<span class="string">"0x%s"</span> % i, <span class="number">16</span>)
    <span class="keyword">return</span> r

<span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(strCipher,strKey)</span>:</span>
    listCipher = map(<span class="keyword">lambda</span> x: int(x),strCipher.replace(<span class="string">'-'</span>,<span class="string">' -'</span>)[<span class="number">1</span>:].split(<span class="string">' '</span>))
    strKeySHA1 = sha1(strKey)
    intSHA1 = calc(strKeySHA1)
    strPlain = <span class="string">''</span>
    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(listCipher)):
        strPlain += chr(listCipher[i] + intSHA1 - int(<span class="string">"0x%s"</span> % strKeySHA1[i%<span class="number">40</span>],<span class="number">16</span>))
        intSHA1 = calc(sha1(strPlain[:(i + <span class="number">1</span>)])[:<span class="number">20</span>] + sha1(str(intSHA1))[:<span class="number">20</span>])
    <span class="keyword">return</span> strPlain

<span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:
    strCipher= <span class="string">'-185-147-211-221-164-217-188-169-205-174-211-225-191-234-148-199-198-253-175-157-222-135-240-229-201-154-178-187-244-183-212-222-164'</span>
    strKey = <span class="string">'zijisuan'</span>
    strPlain = decrypt(strCipher, strKey)
    <span class="keyword">print</span> strPlain
</code></pre><p>最终获得flag。</p><h2 id="0x07-后话"><a href="#0x07-后话" class="headerlink" title="0x07 后话"></a>0x07 后话</h2><p>我才不会告诉你集各路赛棍大牛的群号在博客上。</p></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Link</a></li><li><a href="/archives/">Archives</a></li><li><a href="http://github.com/sunnyelf">Projects</a></li><li><a href="/search/">Search</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-前言"><span class="toc-number">1.</span> <span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-获取key"><span class="toc-number">2.</span> <span class="toc-text">0x01 获取key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-分析flag-py"><span class="toc-number">3.</span> <span class="toc-text">0x02 分析flag.py</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-提取得到pyc文件"><span class="toc-number">4.</span> <span class="toc-text">0x03 提取得到pyc文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-反编译pyc文件得到py源文件"><span class="toc-number">5.</span> <span class="toc-text">0x04 反编译pyc文件得到py源文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-分析py源文件中加密算法"><span class="toc-number">6.</span> <span class="toc-text">0x05 分析py源文件中加密算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-编写解密代码"><span class="toc-number">7.</span> <span class="toc-text">0x06 编写解密代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-后话"><span class="toc-number">8.</span> <span class="toc-text">0x07 后话</span></a></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&text=人生苦短，你需要用Python来做CTF"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&is_video=false&description=人生苦短，你需要用Python来做CTF"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=人生苦短，你需要用Python来做CTF&body=Check out this article: https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&title=人生苦短，你需要用Python来做CTF"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.tumblr.com/share/link?url=https://hackfun.org/2017/01/02/人生苦短，你需要用Python来做CTF/&name=人生苦短，你需要用Python来做CTF&description=&lt;h2 id=&#34;0x00-前言&#34;&gt;&lt;a href=&#34;#0x00-前言&#34; class=&#34;headerlink&#34; title=&#34;0x00 前言&#34;&gt;&lt;/a&gt;0x00 前言&lt;/h2&gt;&lt;p&gt;前一阵子，为了活跃一下群里的气氛，出了一道小题涉及到一些编码，反编译，解密的知识的题目让大家玩，如果你比较感兴趣的话也可以先试着做一做。&lt;/p&gt;&lt;h2 id=&#34;0x01-获取key&#34;&gt;&lt;a href=&#34;#0x01-获取key&#34; class=&#34;headerlink&#34; title=&#34;0x01 获取key&#34;&gt;&lt;/a&gt;0x01 获取key&lt;/h2&gt;"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><ul><li id="toc"><a class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li><li id="share"><a class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li><li id="top" style="display:none"><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li><li id="menu"><a class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li></ul></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2017 Jing Ling</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/about/">About</a></li><li><a href="/link/">Link</a></li><li><a href="/archives/">Archives</a></li><li><a href="http://github.com/sunnyelf">Projects</a></li><li><a href="/search/">Search</a></li></ul></nav></div></footer></body></html><link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link href="https://cdn.bootcss.com/justifiedGallery/3.6.1/css/justifiedGallery.min.css" rel="stylesheet"><script src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script><script src="https://cdn.bootcss.com/justifiedGallery/3.6.1/js/jquery.justifiedGallery.min.js"></script><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/main.min.js"></script><script type="text/javascript">var disqus_shortname="sunnyelf";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script>